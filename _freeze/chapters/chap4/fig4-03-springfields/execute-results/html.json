{
  "hash": "dd862377ee06efedcdf28f49f49c997a",
  "result": {
    "markdown": "---\ntitle: \"Figure 4.3: Many Springfields\"\ncategories: \n  - figures\n  - code\n  - R\nexecute: \n  cache: true\n  freeze: auto\nknitr:\n  opts_chunk: \n    warning: false\n    message: false\n---\n\n\nMany of the data preparation steps for this figure were initially carried out in QGIS. Here they have been implemented in _R_ only.\n\nTo understand why this version is different from the published figure, read on...\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-1_4ef68157ebffd1ac8772b095c413f456'}\n\n```{.r .cell-code}\nlibrary(sf)\nlibrary(tmap)\nlibrary(dplyr)\nlibrary(stringr)\nlibrary(units)\n```\n:::\n\n\n## Get data\nThe 'Springfields' data set was obtained using the following code (shown here but not run) to query the [Nominatim geocoder](https://nominatim.openstreetmap.org/ui/search.html).\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-2_f21b8c0c463105b47838f63c9c902b1e'}\n\n```{.r .cell-code  code-fold=\"true\"}\nlibrary(sf)\nlibrary(dplyr)\nlibrary(stringr)\n\nquery <- \"https://nominatim.openstreetmap.org/search\"\nplace <- \"Springfield\"\nexcluded_places <- \"\"\n\nresult <- NULL\ngot_new_results <- TRUE\nn_results <- 0\nmax_n <- 1000\n\nwhile (n_results < max_n & got_new_results) {\n  url <- str_flatten(c(\n    str_glue(\"{query}?q={place}&\"),\n    \"polygon_geojson=1&limit=50&format=geojson&\",\n    str_glue(\"exclude_place_ids={excluded_places}\")\n  ))\n  download.file(url, \"result.geojson\", quiet = TRUE, method = \"auto\")\n  next_result <- st_read(\"result.geojson\")\n  got_new_results <- dim(next_result)[1] > 0\n  if (is.null(result)) {\n    result <- next_result\n  } else {\n    result <- bind_rows(result, next_result)\n  }\n  n_results <- dim(result)[1]\n  excluded_places <- str_flatten(result$place_id, collapse = \",\")\n  Sys.sleep(1)\n}\n\nresult < result %>% \n  st_centroid() %>% \n  st_write(str_glue(\"all-results-{place}.geojson\"))\n```\n:::\n\n\n## Make a map\nOK, with that done, we can make a map. The degree of difficulty is much increased by choosing a [Briesemeister projection](https://www.map-projections.net/single-view/briesemeister-v2). We choose projections like this one not because they are easy, but because they are hard (something like that...). Anyway the published map is actually an oblique [Hammer-Aitoff projection](https://en.wikipedia.org/wiki/Aitoff_projection), and not the right kind of oblique projection to be a Briesemeister...\n\nRecently, I unearthed a `proj` string at Michael Minn's website, in [the _R_ code](https://michaelminn.net/tutorials/gis-projections-world/world-projections.r) for [this page](https://michaelminn.net/tutorials/gis-projections-world/index.html) that produces the Briesemeister projection. (However... I suspect that code is no longer entirely valid as the `+M` parameter included in that string no longer seems to have any effect on the output and the linked `proj` manual is v4.3, which is a long way out of date.)\n\nAnyway, here's the string we are using&mdash;but even this is not the full story as we will [see later](#as-it-turns-out).\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-3_6777ea4f58dc2882ad93189a7d2c92d6'}\n\n```{.r .cell-code}\nbries <- \"+proj=ob_tran +o_proj=hammer +o_lon_p=0 +o_lat_p=45 +lon_0=10\"\n```\n:::\n\n\n### Dealing with that weird projection\nA world 'disc' for the background. Make this by buffering a point and stretching it to an ellipse with the Hammer projection extent.\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-4_0b65dd6421dec50dcaf1cbcdc4f1c83f'}\n\n```{.r .cell-code}\ndisc <- st_point(c(0, 0)) %>%\n  st_buffer(1, nQuadSegs = 90)\ndisc <- disc * matrix(c(18040096, 0, 0, 9020048), 2, 2)\ndisc <- disc %>%\n  st_sfc() %>%\n  st_sf(crs = bries)\n```\n:::\n\n\nThe world countries must be cut at the Briesemeister 'cut line' which is where there is a break in the projection, to avoid anomalies when places are projected that cross the line. We figured out where this line is in other work...\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-5_f1f527232057622e46b8ca4cb3d90c45'}\n\n```{.r .cell-code}\ndata(\"World\")\n\ncut_line <- st_read(\"briesemeister-cut-corrected.geojson\") %>%\n  st_buffer(1000) # metres!\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nReading layer `briesemeister-cut-corrected' from data source \n  `/Users/osullid3/Documents/code/computing-geographically/chapters/chap4/briesemeister-cut-corrected.geojson' \n  using driver `GeoJSON'\nSimple feature collection with 1 feature and 0 fields\nGeometry type: LINESTRING\nDimension:     XY\nBounding box:  xmin: -170 ymin: -89.99058 xmax: 10 ymax: 44.21063\nGeodetic CRS:  WGS 84\n```\n:::\n\n```{.r .cell-code}\nworld <- World %>%\n  st_difference(cut_line) %>%\n  st_transform(bries)\n```\n:::\n\n\n### Make a graticule \nA graticule - here we assemble this as linestrings (with many points) because projection of `tm_graticules` output can be problematic, especially if the projection has cuts other than at &pm;180&deg; longitude (and even then it can have issues), or as in this case is in any way unusual.\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-6_1dfac325d76cf7de81942ef02d458d81'}\n\n```{.r .cell-code  code-fold=\"true\"}\nget_meridian <- function(longitude) {\n  st_linestring(matrix(cbind(longitude, seq(-90, 90, 1)),\n                       ncol = 2, byrow = FALSE)) %>%\n    st_sfc(crs = 4326)\n}\n\nget_meridians <- function(spacing = 10) {\n  g <- c()\n  for (lon in seq(-180, 180 - spacing, spacing)) {\n    g <- c(g, get_meridian(longitude = lon))\n  }\n  g\n}\n\nget_parallel <- function(latitude) {\n  st_linestring(matrix(cbind(seq(-180, 180, 1), latitude),\n                       ncol = 2, byrow = FALSE)) %>%\n    st_sfc(crs = 4326)\n}\n\nget_parallels <- function(spacing = 10) {\n  g <- c()\n  for (lat in seq(-90 + spacing, 90 - spacing, spacing)) {\n    g <- c(g, get_parallel(latitude = lat))\n  }\n  g\n}\n\ngraticule <- c(get_meridians(), get_parallels()) %>%\n  st_sfc(crs = 4326) %>%\n  # again it must be cut at the Briesemeister breakline\n  st_difference(cut_line) %>%\n  st_sfc() %>%\n  st_sf() %>%\n  st_transform(bries)\n```\n:::\n\n\n### As it turns out\nAs noted, the published map is differently projected that the one we are making here. To get to the Briesemeister proper we have to stretch our oblique Hammer-Aitoff projection. See\n\n> Briesemeister W. 1953. A new oblique equal-area projection. *Geographical Review* **43**(2) 260&ndash;261. doi: [10.2307/211940](https://dx.doi.org/10.2307/211940).\n\nfor details. So let's also do that here (this really is bonus material). We could use the `+proj=affine` transformation with appropriate settings, but I've had issues getting `GDAL` and `tmap` to cooperate with pipeline projected data. Instead, we'll just use the weird matrix post-multiplication of geometries trick that `sf` allows to apply the required stretch. Unfortunately this does not update the CRS information, making these data layers useless for almost any other purpose.\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-7_6920b486ab916a9899408bd54dbcade5'}\n\n```{.r .cell-code}\nstretch_mat <- matrix(c(sqrt(7/8), 0, 0, sqrt(8/7)), 2, 2)\ndisc <- disc %>%\n  mutate(geometry = geometry * stretch_mat)\nworld <- world %>%\n  mutate(geometry = geometry * stretch_mat)\ngraticule <- graticule %>%\n  mutate(geometry = geometry * stretch_mat)\n\n# and not forgetting the Springfields...\nspringfields <- st_read(\"all-results-Springfield.geojson\") %>%\n  st_transform(bries) %>%\n  mutate(geometry = geometry * stretch_mat)\n```\n:::\n\n\nFor what it's worth, all these shenanigans are a good example of why more flexibility in the projection architectures of contemporary platforms would be welcome, something discussed in [Chapter 3](../chap3/index.qmd).\n\n## Yeah, OK, _now_ make a map of all those Springfields\n\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-8_fbdaeb428bf25bd5020d9db88b441d42'}\n\n```{.r .cell-code}\ntm_shape(disc) + \n  tm_fill(col = \"#eeeeee\") + \n  tm_shape(world) + \n  tm_fill(col = \"white\") +\n  tm_shape(springfields) +\n  tm_dots(col = \"red\", size = 0.15, alpha = 0.15) +\n  tm_shape(graticule) +\n  tm_lines(col = \"gray\", lwd = 0.5) +\n  tm_layout(frame = FALSE)\n```\n\n::: {.cell-output-display}\n![](fig4-03-springfields_files/figure-html/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n::: {.cell hash='fig4-03-springfields_cache/html/unnamed-chunk-9_b50d65d483af13182a927becc776cd11'}\n\n```{.r .cell-code  code-fold=\"true\"}\n# License (MIT)\n#\n# Copyright (c) 2023 David O'Sullivan\n#\n# Permission is hereby granted, free of charge, to any person\n# obtaining a copy of this software and associated documentation\n# files (the \"Software\"), to deal in the Software without restriction,\n# including without limitation the rights to use, copy, modify, merge,\n# publish, distribute, sublicense, and/or sell copies of the Software,\n# and to  permit persons to whom the Software is furnished to do so,\n# subject to the following conditions:\n#\n# The above copyright notice and this permission notice shall be included\n# in all copies or substantial portions of the Software.\n#\n# THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n# OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL\n# THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING\n# FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\n# DEALINGS IN THE SOFTWARE.\n```\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}